---
layout: post
title: 조건의 조합 그리고 지식이 담긴 설계
tags:
    - ddd
    - oop
authors: [yangwansu]
---

여기 Domain-Driven-Design[Evans]에서 언급 되고 있는 작지만 의미있는 코드 조작이 있다.  

```java
    dsfsf
```

여기에는 중요한(그렇다고 여겨질 만한) 업무규칙이 포함되어 있는데 보이는가?
확인 되는 조건 분기는 선박이 운항(Voyage) 시 화물(Cargo)에 대한 관행적으로 10% 초과예약(Overbooking)을 허용하는 일종의 정책이다.
몇몇 언젠가 나를 불편하고 힘들게 할 문제들이 보인다.(문제는 문제로 삼아야 문제이다.)
의미가 불분명한 매직넘버(`1.1`) 를 비롯하여 주석(Comment)을 부르는 Data 에 대한 해석등 이 그것들이다.
주석을 부르는 이유는 정책(Policy)지만 정책처럼 코드에서 명시적으로 다루어지지 않기 때문이다. 독자(개발자)로하여금 데이터에 대한 해석을 하도록 유도한다. 

[김춘수의 꽃](https://namu.wiki/w/%EA%BD%83(%EA%B9%80%EC%B6%98%EC%88%98))의 한구절 처럼 정책을 정책으로 부르지못하고 데이터의 해석만 남긴다면 초과예약이 정책은 불분명한 계산식에 불과하게 될 것이다. 

>내가 그의 이름을 불러주기 전에는
> 
>그는 다만
> 
>하나의 몸짓에 지나지 않았다.
>
>내가 그의 이름을 불러주었을 때,
> 
>그는 나에게로 와서
> 
>꽃이 되었다.
>
>내가 그의 이름을 불러준 것처럼
> 
>나의 이 빛깔과 향기에 알맞는
> 
>누가 나의 이름을 불러다오.
> 
>그에게로 가서 나도
> 
>그의 꽃이 되고 싶다.
>
>우리들은 모두
> 
>무엇이 되고 싶다.
> 
>너는 나에게 나는 너에게
> 
>잊혀지지 않는 하나의 눈짓이 되고 싶다.

꽃에 이름을 주어보자. 주석에 대한 냄새를 맡았다면 명료한 의미를 전달하기 위한 수단으로 Extract Method 를 할 수 있다. 이후 





어떤 인사이트도 주지 못한다.
Extract Method 를 통해서 의미를 부여합니다.
어떤 경우에는 이것만으로도 충분하겠지만 비즈니스의 요구사항은 변화하기 마련입니다.

SOLD 객체지향설계의 원칙 중 OCP 는 소프트웨어 개체는 확장에 대해 열려 있어야 하고, 수정에 대해서는 닫혀 있어야 함을 의미합니다.

추가적인 비즈니스 요구사항 확장에 열려 있기 위해 우리는 변화하는 것과 변하지 않는 것을 가려내야합니다.

때로는 조건에 대한 값이 변경하기에 간단한 값 수정 만으로도 목표를 달성할수 있을지 모릅니다.
하지만 세부정책에대한 구현이 변경 된다면 그리 간단하지 않을 것입니다.

DIP 에 이야기하듯 클라이언트는 상위 정책에는 의존하지만 정책에 대한 하위 구현에는 의존하지 않아야 합니다.
정책은 변하지 않고 구현은 변경될 수 있습니다.
Extract Class 를 통해 정책을 추상화 하고 더 나아가 외부에서 주입 받는다면 클라이언트는 더이상 정책의 세부구현에 의존하지 않고 OCP 를 달성하여 확장성을 이룰 수 있을 것입니다.

여기 주문을 처리하는 서비스를 통해서 정책의 세부 조건의 폭발적인 조합의 가능성이 있는 코드가 있습니다.

주문가능여부 검증에 대한 비즈니스 요구사항 에는 다음과 같은 주문 유효성을 다루는 구성들이 있습니다.

주문유효성의 구성
주문자 유효성
구매상품 유효성
주문자와 구매상품 유효성
구매수량 유효성
시스템 유효성

다음 코드는 유효성 검증 조건이 추가 되거나 변경 될 때 마다 조심스럽게 코드를 다루어야 합니다.
단위테스트가 있다면 그나마 다행일것입니다. 그럼에도 불구하고 단위테스트는 케이스에 생성해야하는 여러 조건에 대한 Fixture 들로 금새 피로해질것입니다. 주문서비스의 주요 책임은 주문을 처리 하는것이지 세부유효성검증에 대해서 미주알고주알 일일히 신경을 쓰기에는 지쳐버릴것입니다.

위 간단한 예에서 보았듯이 변하는것과 변하지 않는것을 골라내어야 합니다.

주문처리에서는 유효성검증을 하는것은 변하지 않지만 세부 조건들의 조합들은 변경할 여지가 있습니다.

작은 스텝 그리고 리펙토링

유효성 검증 로직을 위한 코드 블럭 식별
의미부여
책임부여
중복만들기
추상화
약한결합

specification 을 사용 했을 때의 장점
폭발적인 조합에 대한 제어 




