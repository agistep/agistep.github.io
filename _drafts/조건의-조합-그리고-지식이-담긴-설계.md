---
layout: post
title: 조건의 조합 그리고 지식이 담긴 설계
tags:
    - ddd
    - oop
authors: [yangwansu]
---


## TL;DR

[데이터의 해석](#데이터의-해석)을 통해서 전달되는 암묵적인 정책은 커뮤니케이션을 저해하고 가독성을 떨어트리며 
수정에 대해서 열려 있도록 할 가능성이 많습니다.
또한 책임을 모호하게 하게 하여 응집도를 떨어트린다. 테스트케이스가 자주 깨지게 하고 테스트케이스 작성을 기피하게한다.

암묵적인 의미를 가지고 있는 데이터 해석은 이름을 부여하자.
책임은 명확해질것이며 수정에는 닫혀있고 하위구현의 정책에 의존하지 않게되어 응집도 높고 결합도 낮은 결과가 여러분을 미소 짓게 할 것이다.


## 데이터의 해석

아래는 Domain-Driven-Design[Evans]에서 언급 되고 있는 작지만 의미있는 코드 조작이 있다.  

```java
    dsfsf
```

여기에는 중요한(그렇다고 여겨질 만한) 업무규칙이 포함되어 있는데 보이는가?
확인 되는 조건 분기는 선박이 운항(Voyage) 시 화물(Cargo)에 대한 관행적으로 10% 초과예약(Overbooking)을 허용하는 일종의 정책이다.
몇몇 언젠가 나를 불편하고 힘들게 할 문제들이 보인다.(문제는 문제로 삼아야 문제가 된다.)
의미가 불분명한 매직넘버(`1.1`) 를 비롯하여 주석(Comment)을 부르는 Data 에 대한 해석등 이 그것들이다.
주석을 부르는 이유는 정책(Policy)지만 정책처럼 코드에서 명시적으로 다루어지지 않기 때문이다. 독자(개발자)로하여금 데이터에 대한 해석을 하도록 유도한다. 

[김춘수의 꽃](https://namu.wiki/w/%EA%BD%83(%EA%B9%80%EC%B6%98%EC%88%98))의 한구절 처럼 정책을 정책으로 부르지못하고 데이터의 해석만 남긴다면 초과예약이 정책은 불분명한 계산식에 불과하게 될 것이다. 

## 명시적인 정책 

꽃에 이름을 주어보자. 주석에 대한 냄새를 맡았다면 명료한 의미를 전달하기 위한 수단으로 Extract Method 를 할 수 있다.
그러나 Extract Method 만으로는 꽃이 만개 할 수 없다.
코드 세상에서 만 머무르지 않고 명시적정책으로서 의미를 다하기 위한 다면 이름을 가져야한다. Extract Class 하면 이름을 가지게 된다.
이로써 가지는 이점을 보자.

클라이언트는 정책에서 해방된다. 
해방됨의 이점을 확인 해보고자 한다면 테스트케이스를 확인하면 알 수 있다. 

테스트케이스에 보았듯이 클라이언트 코드는 더 이상 정책의 세부구현에 의존적이지 않아도 된다.
세부정책 구현이 변경된다 하더라도 클라이언트는 변경에 의존하지 않는다.([`DIP`]())
세부정책 구현에 의존 될 경우 Fixture 생성에 공을 들여야 한다.

클라이언트는 이로써 추상적인 정책에게 책임을 위임하고 정책에 대한 호출자로써 역할을 다 할 수 있게되었다.
클라언트가 정책과 약한 결합을 이루어졌다면 구체클래스의 생성과도 이별하게 된다면 전략의 주입을 통해 정책의 다형성을 십분 활용 할 수 있게된다. 

이 모든것은 테스트케이스를 통해 확인 할 수 있다.
Mock을 통해 정책의 성공과 실패에 대한 결과 처리에만 신경을 쓸 수 있도록 한 점을 보자. 

역으로 테스트케이스를 통해서 본 설계를 도출 해 낼 수도 있다. 설계적인 이점을 위해서 테스트케이스를 먼저 작성 해보면 이해 할 것이다. 
테스트케이스가 자주 깨진다면 고려해볼만하다. 그전에 테스트케이스가 자주 깨지지 않도록 노력 한다면 위와 같은 설계가 유도된다. 

클라언트의 입장에서는 추가 비즈니스 요구사항에 대해서는 열려있고 수정에는 닫혀 있게 된다. 
정책의 세부구현이 변경되어도 수정이 필요하지 않다. 

클라이언트의 책임과 역할이 명확해지고 드디어 이름을 가지게 된 정책클래스는 외부와 커뮤니케이션 하는데 있어 좋은 도구가 되며 도메인 지식과 코드가 일치하게 되는 지점이 된다.
이제 굳이 초과예약에 대해서 주석을 쓸 필요가 없어졌다. 

이어 정책의 세부 구현 시 조건 조합이 폭발적으로 증가 해도 수정에는 닫혀있도록 Specificatin Pattern 을 활용 하는 방안을 소개하도록 하겠다.  

## 김춘수의 꽃

>내가 그의 이름을 불러주기 전에는
>
>그는 다만
>
>하나의 몸짓에 지나지 않았다.
>
>내가 그의 이름을 불러주었을 때,
>
>그는 나에게로 와서
>
>꽃이 되었다.
>
>내가 그의 이름을 불러준 것처럼
>
>나의 이 빛깔과 향기에 알맞는
>
>누가 나의 이름을 불러다오.
>
>그에게로 가서 나도
>
>그의 꽃이 되고 싶다.
>
>우리들은 모두
>
>무엇이 되고 싶다.
>
>너는 나에게 나는 너에게
>
>잊혀지지 않는 하나의 눈짓이 되고 싶다.